---
import Card from "@/components/ui/astro/Card.astro";
import Button from "@/components/ui/astro/Button.astro";
import ExternalLink from "@lucide/astro/icons/external-link";
import { Picture } from "astro:assets";
import type { Project } from "@/data/projects";

interface Props {
  projects: Project[];
}

const { projects } = Astro.props;

const projectImages = import.meta.glob("../assets/projects/*.{png,jpg,jpeg,webp,avif}", {
  eager: true,
  import: "default",
});

const resolveAsset = (path: string | undefined | null) => {
  if (!path) return null;
  const normalized = path.replace(/^\/?images\/projects\//, "");
  const key = `../assets/projects/${normalized}`;
  return projectImages[key] || null;
};
---

<div class="grid gap-6 md:grid-cols-2">
  {projects.map((project, idx) => {
    const delay = `${idx * 60}ms`;
    const iconAlt = `${project.title} icon`;
    const screenshotAlt = `${project.title} screenshot`;
    const iconSrc = resolveAsset(project.icon);
    const screenshotSrc = resolveAsset(project.screenshot);
    return (
      <Card
        class="transition duration-200 hover:-translate-y-0.5 hover:shadow-md animate-rise"
        style={`animation-delay: ${delay};`}
      >
        <div slot="header" class="flex items-center gap-3">
          {iconSrc ? (
            <Picture
              src={iconSrc}
              alt={iconAlt}
              widths={[32, 48, 64]}
              sizes="32px"
              formats={["avif", "webp", "png"]}
              class="h-8 w-8 rounded-md"
              loading="lazy"
            />
          ) : project.icon ? (
            <img
              src={project.icon}
              alt={iconAlt}
              width="32"
              height="32"
              class="h-8 w-8 rounded-md"
              loading="lazy"
              decoding="async"
            />
          ) : null}
          <h3 class="text-xl font-semibold text-primary">{project.title}</h3>
        </div>

        <div slot="content">
          {screenshotSrc ? (
            <div class="-mx-6 mb-4 overflow-hidden rounded-xl border border-border/60 bg-black/5 dark:bg-white/5">
              <Picture
                src={screenshotSrc}
                alt={screenshotAlt}
                widths={[640, 960, 1400]}
                sizes="(max-width: 768px) 100vw, 680px"
                formats={["avif", "webp", "png"]}
                class="aspect-[16/9] h-auto w-full object-cover object-top"
                loading="lazy"
              />
            </div>
          ) : project.screenshot ? (
            <div class="-mx-6 mb-4 overflow-hidden rounded-xl border border-border/60 bg-black/5 dark:bg-white/5">
              <img
                src={project.screenshot}
                alt={screenshotAlt}
                class="aspect-[16/9] h-auto w-full object-cover object-top"
                loading="lazy"
                decoding="async"
              />
            </div>
          ) : null}
          <p class="mt-6 text-sm leading-relaxed text-muted-foreground">{project.description}</p>
        </div>

        <div slot="footer">
          <div class="flex flex-wrap gap-3">
            {project.links?.map((link) => (
              <Button
                href={link.url}
                variant="outline"
                target="_blank"
                rel="noopener noreferrer"
              >
                {link.label}
                <ExternalLink class="h-4 w-4" />
              </Button>
            ))}
          </div>
        </div>
      </Card>
    );
  })}
</div>
